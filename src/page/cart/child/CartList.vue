<template>
	<div class="cart-list-wrapper">
		<!-- <p class="none-selected-all">{{ isSelectedAll }}</p>  v-bind:class="{'has-bottom': type}"-->

		<div class="list" v-for="(item, index) in cartList">
			<div class="list-checkbox">
				<input type="checkbox" class='checkbox' :id='index' v-model="item.checked" @change="changeSingleStatu(item.checked, index)">
				<label :for="index"></label>
			</div>
			<img :src="item.product.photos[0].thumb" v-if='item.product.photos.length > 0'>
			<img src="../../../assets/image/change-icon/default_image_02@2x.png" v-if='item.product.photos.length <= 0'>
			<div class="list-info">
				<h3> {{ item.product.name}}</h3>
				<div class="info-price">
					<p>AED {{ item.product.current_price }}</p>
					<div class="ui-number">
						<div class="reduce ui-common" @click="reduceNumber(item.id, item.amount, index)">-</div><input type="number" min="1" class="number" value="1" v-model="item.amount" readonly="true"><div class="add ui-common" @click="addNumber(item.id, item.amount, item.product.good_stock, index)">+</div>
					</div>
				</div>
			</div>
		</div>

	</div>
</template>

<script>
	import { mapState, mapMutations } from 'vuex';
	import { Indicator } from 'mint-ui';
	import { Toast } from 'mint-ui';
	import { orderPrice } from '../../../api/network/order';
	import { cartGet, cartDelete, cartUpdate} from '../../../api/network/cart'
	export default {
		data() {
			return {
				cartList: [], //购物车列表
				indicator: { spinnerType: 'fading-circle'},
				orderprice: [], // 购物车总价
				total_amount: 0, //购物车数量
				promosIds: []  //促销信息IDS
			}
		},

		created(){
			this.getCartList(true);
		},

		props: {
			isCheckedAll: {
				type: Boolean,
				default: false
			}
		},

		mounted() {

		},

		methods: {
			...mapMutations({
				getAmount: 'calculationAmount',
				getPrice: 'calculationPrice'
			}),

			/*
			 * getCartList: 获取购物车列表
			 */
			getCartList(value){
				cartGet().then(res => {
					if (res && res.goods_groups.length > 0) {
						this.cartList = Object.assign([], res.goods_groups[0].goods);
						this.addChecked(value);
						this.renderCart();
					}
				})
			},

			/*
			 * addChecked: 为每个商品添加checked 属性
			 * @param: isSelectedall 是否选中商品 Boolean
			 */
			addChecked(isSelectedall) {
				let list = this.cartList;
				for (let i = 0, len = list.length-1; i <= len; i++ ) {
					list[i].checked = isSelectedall;
				}
				this.cartList = Object.assign([], list);
			},

			/*
			 *  updateList: 加减之后更新列表
			 */
			updateList(index) {
				cartGet().then(res => {
					if (res && res.goods_groups.length > 0) {
						Indicator.close();
						let data = res.goods_groups[0].goods;
						this.cartList[index].amount = data[index].amount;
						this.renderCart();
					}
				})
			},

			/*
			 *  renderCart: 修改商品数量和点击是否选中后 重新计算商品价格和数量
			 */
			renderCart() {
				let data = this.cartList;
				this.total_amount = 0;
				this.orderprice = [];
				this.promosIds = [];
				for (let i = 0, len = data.length; i <= len-1; i++) {
					if (data[i].checked) {
						this.orderprice.push({'goods_id': data[i].product.id, 'property': [], 'num': data[i].amount});
						this.promosIds.push(data[i].id);
						this.total_amount += data[i].amount;
					}
				}
				this.$parent.$emit('get-promos-data', this.promosIds);
				this.getOrderPrice();
			},

			/*
			 *  getOrderPrice 获取购物车价格
			 */
			getOrderPrice(){
				let params = {
					'shop': null,
					'order_product':'',
					'consignee':null,
					'shipping':null,
					'coupon': null,
					'cashgift':null,
					'score': null
				};
				if (this.orderprice.length > 0 ) {
					params.order_product = JSON.stringify(this.orderprice);
				} else {
					this.getAmount(0);
					this.getPrice(0.00);
					return;
				}
				orderPrice(params.shop, params.order_product, params.consignee, params.shipping, params.coupon, params.cashgift, params.score).then(res => {
					if (res) {
						let price = res.order_price.product_price;
						this.getAmount(this.total_amount);
						this.getPrice(price);
					}
				})
			},

			/*
			 * deleteSelected: 删除购物车数据
			 */
			deleteSelected() {
				let data = this.cartList,
					deleteGoods = [];
				this.promosIds = [];
				for (let i = 0, len = data.length; i <= len-1; i++) {
					if (data[i].checked) {
						deleteGoods.push(data[i].id);
						this.promosIds.push(data[i].id);
					}
				}
				if (deleteGoods.length > 0) {
					deleteGoods = JSON.stringify(deleteGoods);
				} else {
					Toast('当前没有可删除的商品');
					return;
				}
				Indicator.open();
				cartDelete(deleteGoods).then(res => {
					if (res) {
						this.getCartList(false);
						Indicator.close();
					}
				})
			},

			/*
			 *  changeSingleStatu: 改变单个商品是否选中的状态, 然后重新获取商品的件数和价格
			 *  @param ： state 选中的状态
			 *  @param: index 当前改变的商品的index
			 */
			changeSingleStatu(state, index) {
				let data = this.cartList,
					length = 0,
					status = false;
				for (let i = 0, len = data.length-1; i <= len; i++ ) {
					if (data[i].checked) {
						length = length+1;
					}
				}
				if (length == data.length) {
					status = true;
				} else {
					status = false;
				}
				this.$parent.$emit('change-footer-status', status);
				if (!this.isCheckedAll) {
					this.renderCart();
				}
			},

			/*
			 *  reduceNumber: 数量减少
			 *  @param: id 当前减少的商品id
			 *  @param: amount 数量
			 *  @param： index 当前减少的index
			 */
			reduceNumber(id, amount, index) {
				if (amount > 1) {
					Indicator.open(this.indicator);
					amount--;
					this.updateCartQuantity(id, amount, index);
				} else {
					Toast({
						duration:1000,
						message: '受不了了， 宝贝不能再少了'
					});
				}
			},

			/*
			 *  addNumber: 数量增加
			 *  @param: id 当前减少的商品id
			 *  @param: amount 数量
			 *  @param: stock 库存
			 *  @param： index 当前减少的index
			 */
			addNumber(id, amount, stock, index) {
				if (amount <= stock) {
					Indicator.open(this.indicator);
					amount++;
					this.updateCartQuantity(id, amount, index);
				} else {
					Toast({
						duration:1000,
						message: '该商品总库存不足'
					});
				}
			},

			/*
			 * updateCartQuantity: 商品数量加减更新数
			 * @param: id 当前减少的商品id
			 * @param: amount 数量
			 * @param： index 当前操作的商品的index
			 */
			updateCartQuantity(id, amount, index) {
				cartUpdate(id, amount).then( res => {
					if (res) {
						this.updateList(index);
					}
				});
			}
		}
	}
</script>

<style lang='scss' scoped>
	.cart-list-wrapper {
		overflow: auto;
		position: absolute;
	    width: 100%;
	    bottom: 44px;
	    top: 44px;
		p.none-selected-all {
			display: none;
		}
		.list {
			display: flex;
			align-content: center;
			align-items: center;
			background-color: #fff;
			padding:12px;
			border-bottom: 1px solid #E8EAED;
			div.list-checkbox {
				width: 20px;
				height:20px;
				flex-basis: 20px;
				flex-shrink: 0;
				position: relative;
				margin-right: 5px;
				label {
					position: absolute;
					top: 0px;
					width: 20px;
					height: 20px;
					display: inline-block;
					background: url('../../../assets/image/change-icon/choice@2x.png') no-repeat;
					background-size: cover;
				}
				input {
					position: relative;
					width: 20px;
					/*height: 20px;*/
					margin: 0px;
					z-index: -999;
					background-color: #fff;
					&:checked + label {
						background: url('../../../assets/image/change-icon/multi_sel@2x.png') no-repeat;
						background-size: cover;
						width: 20px;
						height: 20px;
					}
					&:focus {
						outline-offset: 0px;
					}
				}
			}
			img {
				width: 90px;
				height: 90px;
				flex-shrink: 0;
				flex-basis: 90px;
				border: 1px solid #E8EAED;
				border-radius: 3px;
			}
			div.list-info {
				margin-left: 5px;
				height: 90px;
				width: 100%;
				position: relative;
				h3{
					font-size:14px;
					font-family:'PingFangSC-Regular';
					color:rgba(78,84,93,1);
					padding: 0px;
					margin: 0px;
					display: -webkit-box;
					-webkit-box-orient: vertical;
					-webkit-line-clamp: 2;
					overflow: hidden;
				}
				div.info-price {
					width: 100%;
					display: flex;
					justify-content: space-between;
					align-content: center;
					align-items: center;
					margin-top: 18px;
					position: absolute;
    				bottom: 0px;
					p {
						font-size:17px;
						font-family:'PingFangSC-Regular';
						color:rgba(242,48,48,1);
						line-height:17px;
						padding: 0px;
						margin: 0px;
						display: inline-block;
					}
				}
				div.ui-number{
					height: 24px;
					display: flex;
					input, div {
						height: 24px;
						text-align: center;
						color: #404245;
						display: inline-block;
						padding: 0px;
						margin:  0px;
						border:  0px;
						outline-offset: 0px;
					}
					.ui-common {
						line-height: 24px;
						width: 26px;
						height: 24px;
						border:  1px solid #404245;
						cursor: pointer;
					}
					.reduce {
						opacity:0.4;
						border-right: 0px;
					}
					.add {
						border-left: 0px;
					}
					input[type='number'] {
						width: 26px;
						border: 1px solid #404245;
						border-radius: 0px;
						border-image-width: 0px;
						box-shadow: 0px;
						vertical-align: bottom;
						&:focus {
							outline: none;
						}
					}
				}
			}
		}
	}
	.has-bottom {
		bottom: 94px;
	}
</style>
